<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€€ä¼‘é‡‘å®šæœŸå®šé¡è¦åŠƒ | Retirement Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Markdown è§£æåº« -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Chosen Palette: Warm Neutrals & Stability -->
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; /* é‡å° WebKit ç€è¦½å™¨ (Chrome, Safari) */
            appearance: none;         /* æ¨™æº–å±¬æ€§ (ä¿®å¾© VS Code ç›¸å®¹æ€§è­¦å‘Š) */
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;         /* æ¨™æº–å±¬æ€§ */
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #059669; /* emerald-600 */
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e7e5e4; /* stone-200 */
            border-radius: 2px;
        }
        
        /* Chart Container RWD */
        .chart-container-responsive {
            position: relative;
            width: 100%;
            height: 350px;
            max-height: 400px;
        }
        @media (max-width: 640px) {
            .chart-container-responsive {
                height: 250px;
            }
        }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f5f5f4; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a29e; }

        /* Markdown Styles */
        .markdown-body h3 { font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em; color: #064e3b; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.25em; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body strong { color: #047857; font-weight: 600; }
        .markdown-body a { color: #059669; text-decoration: underline; }
        
        /* Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .animate-pulse-ring { animation: pulse-ring 2s infinite; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 antialiased h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-stone-200 shadow-sm flex-none z-20">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ¢</span>
                <h1 class="text-xl font-bold tracking-tight text-stone-900">é€€ä¼‘é‡‘å®šæœŸå®šé¡è¦åŠƒ <span class="text-sm font-normal text-stone-500 hidden sm:inline">| DCA Planner</span></h1>
            </div>
            
            <div class="flex items-center bg-stone-100 rounded-lg p-1 border border-stone-200">
                <button id="btn-nominal" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-200 text-stone-500 hover:text-stone-900" onclick="setMode('nominal')">
                    åç›®é‡‘é¡ (å«é€šè†¨)
                </button>
                <button id="btn-real" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-200 bg-white text-emerald-700 shadow-sm ring-1 ring-black/5" onclick="setMode('real')">
                    å¯¦è³ªè³¼è²·åŠ› (æ‰£é™¤é€šè†¨)
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden max-w-screen-2xl mx-auto w-full">
        
        <!-- Sidebar: Control Center -->
        <aside class="w-full lg:w-96 bg-white border-r border-stone-200 flex-none overflow-y-auto custom-scrollbar z-10">
            <div class="p-6 space-y-8">
                
                <!-- 1. Profile -->
                <div class="space-y-2">
                    <h2 class="text-sm font-bold uppercase tracking-wider text-stone-400">å€‹äººè¨­å®š (Profile)</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-stone-600 mb-1">ç›®å‰å¹´é½¡</label>
                            <input type="number" id="currentAge" value="30" class="w-full p-2 bg-stone-50 border border-stone-200 rounded text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition" oninput="updateSim()">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-stone-600 mb-1">é è¨ˆé€€ä¼‘å¹´é½¡</label>
                            <input type="number" id="retireAge" value="65" class="w-full p-2 bg-stone-50 border border-stone-200 rounded text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition" oninput="updateSim()">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-stone-600 mb-1">é æœŸå£½å‘½</label>
                        <input type="number" id="deathAge" value="90" class="w-full p-2 bg-stone-50 border border-stone-200 rounded text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition" oninput="updateSim()">
                        <p class="text-[10px] text-stone-400 mt-1">* åœ‹äººå¹³å‡å£½å‘½ç´„80æ­²ï¼Œå»ºè­°è¦åŠƒè‡³90æ­²ä»¥å‚™é•·å£½é¢¨éšªã€‚</p>
                    </div>
                </div>

                <!-- 2. Cash Flow (Revised) -->
                <div class="space-y-4">
                    <h2 class="text-sm font-bold uppercase tracking-wider text-stone-400">ç¾é‡‘æµé…ç½® (Cash Flow)</h2>
                    
                    <!-- Principal -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-medium text-stone-600">ç›®å‰å·²å‚™è³‡ç”¢ (PV)</label>
                            <span class="text-xs font-bold text-emerald-700" id="disp-principal">$1,000,000</span>
                        </div>
                        <input type="range" id="initialPrincipal" min="0" max="10000000" step="10000" value="1000000" oninput="updateDisp('initialPrincipal', this.value); updateSim()">
                        <input type="number" id="initialPrincipalNum" value="1000000" class="mt-1 w-full p-1.5 text-xs border border-stone-200 rounded text-right text-stone-500" oninput="syncRange('initialPrincipal', this.value); updateSim()">
                    </div>

                    <!-- Monthly Contribution Items -->
                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 space-y-3">
                        <label class="text-[10px] text-stone-500 block mb-1 font-bold">å®šæœŸå®šé¡æŠ•å…¥é …ç›® (Monthly DCA)</label>
                        <div class="flex gap-2">
                            <input type="text" id="contribNameInput" class="w-2/3 text-xs p-1.5 border border-stone-300 rounded" placeholder="é …ç›® (å¦‚: 0050, å„²è“„éšª)">
                            <input type="number" id="contribAmountInput" class="w-1/3 text-xs p-1.5 border border-stone-300 rounded text-right" placeholder="é‡‘é¡">
                        </div>
                        <button onclick="addContribItem()" class="w-full px-4 py-1.5 bg-emerald-600 text-white text-xs rounded hover:bg-emerald-700 transition">åŠ å…¥æŠ•å…¥é …ç›®</button>
                        
                        <!-- List -->
                        <div id="contribList" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- JS Rendered Items -->
                        </div>
                    </div>

                    <!-- Total Monthly Contribution Display -->
                    <div class="flex justify-between items-center bg-emerald-50 p-3 rounded border border-emerald-100">
                        <span class="text-xs font-medium text-stone-600">æ¯æœˆç¸½æŠ•å…¥é‡‘é¡</span>
                        <span class="text-lg font-bold text-emerald-700" id="disp-total-monthly">$0</span>
                        <!-- Hidden input to store value for calculation logic -->
                        <input type="hidden" id="monthlyContrib" value="0">
                    </div>

                    <!-- DCA Return Rate (New Dual-Track Control) -->
                    <div class="bg-emerald-50/50 p-2 rounded border border-emerald-100/50">
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-medium text-stone-600">å®šæœŸå®šé¡é æœŸå ±é…¬ç‡ (DCA Rate)</label>
                            <span class="text-xs font-bold text-emerald-700" id="disp-dca-return">6.0%</span>
                        </div>
                        <input type="range" id="dcaReturn" min="0" max="15" step="0.1" value="6.0" oninput="updateDisp('dcaReturn', this.value); updateSim()">
                        <p class="text-[10px] text-stone-400 mt-1">æ­¤å ±é…¬ç‡åƒ…é©ç”¨æ–¼ã€Œæœªä¾†æ¯æœˆæ–°æŠ•å…¥ã€çš„è³‡é‡‘ã€‚</p>
                    </div>

                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-medium text-stone-600">æŠ•å…¥é‡‘é¡å¹´æˆé•·ç‡</label>
                            <span class="text-xs font-bold text-amber-600" id="disp-contrib-growth">0%</span>
                        </div>
                        <input type="range" id="contribGrowth" min="0" max="20" step="0.5" value="0" oninput="updateDisp('contribGrowth', this.value); updateSim()">
                    </div>
                </div>

                <!-- 3. Portfolio & Market -->
                <div class="space-y-4 border-t border-stone-100 pt-4">
                    <h2 class="text-sm font-bold uppercase tracking-wider text-stone-400">ç¾æœ‰è³‡ç”¢é…ç½® (Existing Assets)</h2>
                    <p class="text-xs text-stone-500">æ­¤å€è¨­å®šåƒ…å½±éŸ¿ã€Œç›®å‰å·²å‚™è³‡ç”¢ (PV)ã€çš„å ±é…¬ç‡ã€‚</p>

                    <!-- Add Asset Interface -->
                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 space-y-3">
                        <div class="grid grid-cols-1 gap-2">
                            <div>
                                <label class="text-[10px] text-stone-500 block mb-1">è³‡ç”¢ä»£è™Ÿ/åç¨±</label>
                                <div class="flex gap-2">
                                    <input type="text" id="assetNameInput" class="w-full text-xs p-1.5 border border-stone-300 rounded" placeholder="å¦‚: 2330, VOO">
                                    <select id="assetHelperSelect" class="w-24 text-xs p-1.5 border border-stone-300 rounded bg-white text-stone-500" onchange="fillAssetInputs(this)">
                                        <option value="">å¿«é€Ÿé¸å–®</option>
                                        <optgroup label="ğŸ‡ºğŸ‡¸ ç¾è‚¡ ETF">
                                            <option value="VOO" data-ret="10.0">VOO (æ¨™æ™®500)</option>
                                            <option value="SPY" data-ret="10.0">SPY (æ¨™æ™®500)</option>
                                            <option value="QQQ" data-ret="12.0">QQQ (é‚£æ–¯é”å…‹)</option>
                                            <option value="VTI" data-ret="9.5">VTI (å…¨ç¾å¸‚å ´)</option>
                                            <option value="VT" data-ret="8.0">VT (å…¨çƒè‚¡å¸‚)</option>
                                        </optgroup>
                                        <optgroup label="âš–ï¸ è‚¡å‚µå¹³è¡¡/é…ç½®å‹">
                                            <option value="AOA" data-ret="7.0">AOA (ç©æ¥µé…ç½®)</option>
                                            <option value="AOR" data-ret="6.0">AOR (æˆé•·é…ç½®)</option>
                                        </optgroup>
                                        <optgroup label="ğŸ‡¹ğŸ‡¼ å°è‚¡">
                                            <option value="0050" data-ret="9.0">0050 (å°ç£50)</option>
                                            <option value="0056" data-ret="6.0">0056 (é«˜è‚¡æ¯)</option>
                                            <option value="00878" data-ret="6.0">00878 (æ°¸çºŒé«˜è‚¡æ¯)</option>
                                            <option value="2330" data-ret="12.0">2330 (å°ç©é›»)</option>
                                        </optgroup>
                                        <optgroup label="ğŸ›¡ï¸ å‚µåˆ¸/ä¿å®ˆ">
                                            <option value="BNDW" data-ret="4.0">BNDW (å…¨çƒå‚µ)</option>
                                            <option value="TLT" data-ret="3.5">TLT (ç¾é•·å‚µ)</option>
                                            <option value="CASH" data-ret="1.5">ç¾é‡‘/å®šå­˜</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <label class="text-[10px] text-stone-500 block mb-1">é æœŸå ±é…¬ %</label>
                                <input type="number" id="assetReturnInput" class="w-full text-xs p-1.5 border border-stone-300 rounded text-right" placeholder="0.0">
                            </div>
                            <div class="w-1/2">
                                <label class="text-[10px] text-stone-500 block mb-1">é…ç½®æ¬Šé‡ %</label>
                                <input type="number" id="assetWeightInput" class="w-full text-xs p-1.5 border border-stone-300 rounded text-right" placeholder="ä¾‹å¦‚: 25">
                            </div>
                        </div>
                        <button onclick="addAsset()" class="w-full px-4 py-1.5 bg-stone-800 text-white text-xs rounded hover:bg-stone-700 transition">åŠ å…¥æŠ•è³‡çµ„åˆ</button>
                    </div>

                    <!-- Portfolio List -->
                    <div id="portfolioList" class="space-y-2">
                        <!-- JS Rendered Items -->
                    </div>
                    
                    <!-- Portfolio Summary -->
                    <div class="flex justify-between items-center text-xs pt-2 border-t border-stone-200">
                        <span class="text-stone-500">ç¸½é…ç½®: <span id="totalWeight" class="font-bold">0%</span></span>
                        <span class="text-stone-500">åŠ æ¬Šå ±é…¬: <span id="weightedReturn" class="font-bold text-emerald-600">0.0%</span></span>
                    </div>

                    <!-- Market Assumptions -->
                    <div class="pt-2">
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-medium text-stone-600">ç¾æœ‰è³‡ç”¢é æœŸå¹´åŒ–å ±é…¬ç‡</label>
                            <span class="text-xs font-bold text-emerald-700" id="disp-return">6.0%</span>
                        </div>
                        <input type="range" id="annualReturn" min="0" max="15" step="0.1" value="6.0" oninput="updateDisp('annualReturn', this.value); updateSim()">
                        <p class="text-[10px] text-stone-400 mt-1 leading-normal">
                            * ä¾†è‡ªä¸Šæ–¹æŠ•è³‡çµ„åˆçš„åŠ æ¬Šå¹³å‡ï¼Œå½±éŸ¿æœ¬é‡‘å¢é•·ã€‚
                        </p>
                    </div>

                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-medium text-stone-600">é ä¼°é€šè²¨è†¨è„¹ç‡</label>
                            <span class="text-xs font-bold text-rose-600" id="disp-inflation">2.0%</span>
                        </div>
                        <input type="range" id="inflationRate" min="0" max="10" step="0.1" value="2.0" oninput="updateDisp('inflationRate', this.value); updateSim()">
                    </div>
                </div>

                <!-- 4. Goal -->
                <div class="space-y-4 pt-4 border-t border-stone-100">
                    <h2 class="text-sm font-bold uppercase tracking-wider text-stone-400">é€€ä¼‘ç›®æ¨™ (Goal)</h2>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-medium text-stone-600">é€€ä¼‘å¾Œæ¯æœˆæé ˜éœ€æ±‚ (ç¾å€¼)</label>
                            <span class="text-xs font-bold text-stone-700" id="disp-withdraw">$40,000</span>
                        </div>
                        <input type="range" id="monthlyWithdraw" min="10000" max="300000" step="5000" value="40000" oninput="updateDisp('monthlyWithdraw', this.value); updateSim()">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-medium text-stone-600">æœŸæœ›é€€ä¼‘è³‡ç”¢ç›®æ¨™ (ç¾å€¼)</label>
                            <span class="text-xs font-bold text-stone-700" id="disp-target">$20,000,000</span>
                        </div>
                        <input type="range" id="targetGoal" min="5000000" max="100000000" step="100000" value="20000000" oninput="updateDisp('targetGoal', this.value); updateSim()">
                    </div>
                </div>

                <div class="pb-12 text-[10px] text-stone-400 leading-relaxed">
                    <p>å…è²¬è²æ˜ï¼šå ±é…¬ç‡åƒ…ç‚ºæ­·å²åƒè€ƒï¼Œä¸ä»£è¡¨æœªä¾†ç¸¾æ•ˆã€‚æŠ•è³‡æœ‰é¢¨éšªã€‚</p>
                </div>
            </div>
        </aside>

        <!-- Visualization Dashboard -->
        <div class="flex-1 flex flex-col min-w-0 bg-stone-50 overflow-y-auto custom-scrollbar">
            
            <!-- KPI Cards -->
            <div class="p-4 sm:p-6 lg:p-8 pb-0">
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-stone-800">è³‡ç”¢é æ¸¬å„€è¡¨æ¿</h3>
                    <p class="text-sm text-stone-500" id="header-subtitle">åŸºæ–¼ç›®å‰è¨­å®šçš„ç´¯ç©æœŸè©¦ç®—çµæœ</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-4">
                    <!-- KPI 1 -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition"><span class="text-4xl">ğŸ’°</span></div>
                        <p class="text-xs font-medium text-stone-500 uppercase">é€€ä¼‘æ™‚è³‡ç”¢ç¸½é¡</p>
                        <p class="text-2xl font-bold text-emerald-700 mt-1" id="kpi-total-assets">Loading...</p>
                        <p class="text-xs text-stone-400 mt-2">é ä¼°ç´¯ç©é‡‘é¡</p>
                    </div>

                    <!-- KPI 2 -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition"><span class="text-4xl">ğŸŒ±</span></div>
                        <p class="text-xs font-medium text-stone-500 uppercase">æŠ•å…¥æœ¬é‡‘ç¸½å’Œ</p>
                        <p class="text-2xl font-bold text-stone-700 mt-1" id="kpi-principal">Loading...</p>
                        <p class="text-xs text-stone-400 mt-2">å¯¦éš›å¾å£è¢‹æ‹¿å‡ºçš„éŒ¢</p>
                    </div>

                    <!-- KPI 3 -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition"><span class="text-4xl">ğŸ“ˆ</span></div>
                        <p class="text-xs font-medium text-stone-500 uppercase">è¤‡åˆ©æŠ•è³‡æ”¶ç›Š</p>
                        <p class="text-2xl font-bold text-amber-500 mt-1" id="kpi-interest">Loading...</p>
                        <p class="text-xs text-stone-400 mt-2">éŒ¢æ»¾éŒ¢çš„æ•ˆæœ</p>
                    </div>

                    <!-- KPI 4 -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-stone-300 relative overflow-hidden" id="card-status">
                        <p class="text-xs font-medium text-stone-500 uppercase">ç›®æ¨™é”æˆç‡</p>
                        <div class="flex items-baseline gap-2 mt-1">
                            <p class="text-2xl font-bold text-stone-700" id="kpi-percent">0%</p>
                            <span class="text-xs font-bold px-2 py-0.5 rounded-full bg-stone-100 text-stone-500" id="kpi-status-badge">Loading...</span>
                        </div>
                        <p class="text-xs text-stone-400 mt-2" id="kpi-suggestion">Loading...</p>
                    </div>
                </div>

                <!-- Gemini AI Advisor Section -->
                <div class="mb-8">
                    <div class="bg-gradient-to-r from-emerald-50 to-stone-50 rounded-xl border border-emerald-100 p-5 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-white p-2 rounded-lg shadow-sm text-xl">âœ¨</div>
                                <div>
                                    <h4 class="font-bold text-stone-800">Gemini æ™ºèƒ½é€€ä¼‘é¡§å• (å°ç£å°ˆå±¬ç‰ˆ)</h4>
                                    <p class="text-xs text-stone-500">å°‡é‡å°æ‚¨çš„ã€Œè‡ªè¨‚å€‹è‚¡ã€èˆ‡ã€Œé…ç½®ã€é€²è¡Œæœå°‹èˆ‡é¢¨éšªåˆ†æ</p>
                                </div>
                            </div>
                            <!-- API Key Input UI (Bring Your Own Key) -->
                            <div class="flex flex-col gap-2 w-full md:w-auto">
                                <div class="flex gap-2 items-center">
                                    <input type="password" id="userApiKey" class="w-48 text-xs p-1.5 border border-emerald-300 rounded bg-white" placeholder="è²¼ä¸Š Gemini API Key">
                                    <button onclick="saveApiKey()" class="px-3 py-1.5 bg-emerald-100 text-emerald-700 text-xs rounded hover:bg-emerald-200 transition">å„²å­˜ Key</button>
                                </div>
                                <button onclick="callGeminiAdvisor()" id="ai-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-lg shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span>âœ¨ åˆ†ææˆ‘çš„è¦åŠƒ</span>
                                </button>
                            </div>
                        </div>
                        <div class="text-[10px] text-stone-400 text-right mb-2">
                            * Key åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨æœ¬åœ°ç«¯ï¼Œä¿éšœéš±ç§ã€‚ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline text-emerald-600">ç”³è«‹å…è²» Key</a>
                        </div>
                        
                        <div id="ai-response-container" class="hidden border-t border-emerald-100 pt-4 mt-2">
                             <div id="ai-loading" class="hidden flex flex-col items-center justify-center py-6 space-y-3">
                                 <div class="relative w-12 h-12">
                                     <div class="absolute inset-0 rounded-full border-4 border-emerald-100"></div>
                                     <div class="absolute inset-0 rounded-full border-4 border-emerald-500 border-t-transparent animate-spin"></div>
                                 </div>
                                 <p class="text-xs text-emerald-600 font-medium animate-pulse">
                                     æ­£åœ¨åˆ†ææŠ•è³‡çµ„åˆï¼šæœå°‹ AOAã€å°ç©é›»ç­‰æ¨™çš„æ­·å²æ•¸æ“š...<br>
                                 </p>
                             </div>
                             <div id="ai-content" class="text-sm text-stone-700 markdown-body bg-white/50 p-4 rounded-lg"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-4 sm:px-6 lg:px-8 pb-8">
                <!-- Charts -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
                    <div class="xl:col-span-2 bg-white p-5 rounded-xl shadow-sm border border-stone-100 flex flex-col">
                        <div class="mb-4 flex justify-between items-center">
                            <h4 class="font-bold text-stone-700">è³‡ç”¢ç´¯ç©èˆ‡æé ˜è»Œè·¡</h4>
                            <div class="flex gap-2 text-xs">
                                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> è³‡ç”¢ç¸½å€¼</span>
                                <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-stone-300"></div> æŠ•å…¥æœ¬é‡‘</span>
                            </div>
                        </div>
                        <div class="flex-1 w-full min-h-[300px]">
                             <div class="chart-container-responsive mx-auto">
                                <canvas id="wealthChart"></canvas>
                             </div>
                        </div>
                        <p class="text-xs text-stone-400 mt-3 text-center">Xè»¸: å¹´é½¡ (æ­²) &nbsp; | &nbsp; è™›ç·šæ¨™ç¤º: é€€ä¼‘å¹´é½¡</p>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-sm border border-stone-100 flex flex-col">
                        <h4 class="font-bold text-stone-700 mb-4">é€€ä¼‘æ™‚è³‡ç”¢çµæ§‹</h4>
                        <div class="flex-1 flex flex-col justify-center items-center relative">
                            <div class="chart-container-responsive" style="max-height: 250px;">
                                <canvas id="doughnutChart"></canvas>
                            </div>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div class="text-center bg-white/80 p-2 rounded backdrop-blur-sm">
                                    <span class="text-sm text-stone-500">æœ¬åˆ©æ¯”</span>
                                    <div class="text-lg font-bold text-stone-800" id="ratio-text">1:1</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-stone-50 rounded-lg text-xs space-y-2">
                            <div class="flex justify-between">
                                <span class="text-stone-500">åŠ æ¬Šå¹³å‡å¯¦è³ªå ±é…¬ç‡</span>
                                <span class="font-bold text-stone-700" id="stat-real-return">0%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-stone-500">è¤‡åˆ©å€æ•¸</span>
                                <span class="font-bold text-stone-700" id="stat-multiplier">0x</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-stone-100 flex justify-between items-center cursor-pointer hover:bg-stone-50 transition" onclick="toggleTable()">
                        <h4 class="font-bold text-stone-700">å¹´åº¦è³‡ç”¢æ˜ç´°è¡¨</h4>
                        <span class="text-xs text-emerald-600 font-medium">é»æ“Šå±•é–‹/æ”¶åˆ â–¼</span>
                    </div>
                    <div id="table-container" class="hidden overflow-x-auto max-h-96 custom-scrollbar">
                        <table class="w-full text-sm text-left text-stone-600">
                            <thead class="text-xs text-stone-700 uppercase bg-stone-50 sticky top-0 z-10">
                                <tr>
                                    <th scope="col" class="px-6 py-3">å¹´é½¡</th>
                                    <th scope="col" class="px-6 py-3">å¹´åº¦ (ç¬¬Nå¹´)</th>
                                    <th scope="col" class="px-6 py-3 text-right">ç•¶å¹´åº¦æŠ•å…¥</th>
                                    <th scope="col" class="px-6 py-3 text-right">æŠ•å…¥æœ¬é‡‘ç´¯è¨ˆ</th>
                                    <th scope="col" class="px-6 py-3 text-right">è³‡ç”¢ç¸½å€¼</th>
                                </tr>
                            </thead>
                            <tbody id="details-table-body" class="divide-y divide-stone-100"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-8 text-center">
                    <button class="text-xs text-stone-400 hover:text-stone-600 underline" onclick="window.print()">åˆ—å°æ­¤å ±å‘Š</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Init userApiKey from storage
        let userApiKey = localStorage.getItem('gemini_api_key') || "";

        let appState = {
            mode: 'real',
            inputs: {
                currentAge: 30, retireAge: 65, deathAge: 90,
                initialPrincipal: 1000000, monthlyContrib: 10000, contribGrowth: 0,
                annualReturn: 6.0, dcaReturn: 6.0, inflationRate: 2.0,
                monthlyWithdraw: 40000, targetGoal: 20000000
            },
            portfolio: [], // å„²å­˜ { name, return, weight }
            contributionItems: [ // æ–°å¢ï¼šå„²å­˜å®šæœŸå®šé¡é …ç›®
                { id: 1, name: 'ETF å®šæœŸå®šé¡', amount: 10000 }
            ],
            results: []
        };

        let wealthChartInstance = null;
        let doughnutChartInstance = null;

        const formatMoney = (num) => {
            if (num === undefined || num === null || isNaN(num)) return "$0";
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(num);
        };
        const formatPercent = (num) => {
             if (num === undefined || num === null || isNaN(num)) return "0%";
            return num.toFixed(2) + '%';
        };

        function syncRange(id, val) {
            document.getElementById(id).value = val;
            updateDisp(id, val);
        }

        function updateDisp(id, val) {
            if(id === 'initialPrincipal') document.getElementById('disp-principal').textContent = formatMoney(val);
            if(id === 'contribGrowth') document.getElementById('disp-contrib-growth').textContent = val + '%';
            if(id === 'annualReturn') document.getElementById('disp-return').textContent = val + '%';
            if(id === 'dcaReturn') document.getElementById('disp-dca-return').textContent = val + '%';
            if(id === 'inflationRate') document.getElementById('disp-inflation').textContent = val + '%';
            if(id === 'monthlyWithdraw') document.getElementById('disp-withdraw').textContent = formatMoney(val);
            if(id === 'targetGoal') document.getElementById('disp-target').textContent = formatMoney(val);
            
            if(document.getElementById(id + 'Num')) document.getElementById(id + 'Num').value = val;
        }

        function setMode(mode) {
            appState.mode = mode;
            if(mode === 'real') {
                document.getElementById('btn-real').className = "px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-200 bg-white text-emerald-700 shadow-sm ring-1 ring-black/5";
                document.getElementById('btn-nominal').className = "px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-200 text-stone-500 hover:text-stone-900";
                document.getElementById('header-subtitle').textContent = "é¡¯ç¤ºæ•¸å€¼å·²æ‰£é™¤é€šè†¨ (ä»¥ä»Šæ—¥è³¼è²·åŠ›å‘ˆç¾)";
            } else {
                document.getElementById('btn-nominal').className = "px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-200 bg-white text-emerald-700 shadow-sm ring-1 ring-black/5";
                document.getElementById('btn-real').className = "px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-200 text-stone-500 hover:text-stone-900";
                document.getElementById('header-subtitle').textContent = "é¡¯ç¤ºæ•¸å€¼ç‚ºæœªä¾†å¸³é¢é‡‘é¡ (åŒ…å«é€šè†¨)";
            }
            updateSim();
        }

        function toggleTable() {
            const el = document.getElementById('table-container');
            el.classList.toggle('hidden');
        }

        // --- API Key Management ---
        function saveApiKey() {
            const input = document.getElementById('userApiKey');
            const key = input.value.trim();
            if (key) {
                userApiKey = key;
                localStorage.setItem('gemini_api_key', key);
                alert("API Key å·²å„²å­˜è‡³ç€è¦½å™¨ï¼");
            } else {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key");
            }
        }

        // --- Monthly Contribution Item Logic ---
        function addContribItem() {
            const nameInput = document.getElementById('contribNameInput');
            const amountInput = document.getElementById('contribAmountInput');
            
            const name = nameInput.value.trim() || 'æœªå‘½åé …ç›®';
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡");
                return;
            }

            appState.contributionItems.push({
                id: Date.now(),
                name: name,
                amount: amount
            });

            nameInput.value = '';
            amountInput.value = '';
            
            updateContribUI();
        }

        function removeContribItem(id) {
            appState.contributionItems = appState.contributionItems.filter(item => item.id !== id);
            updateContribUI();
        }

        function updateContribUI() {
            const list = document.getElementById('contribList');
            const dispTotal = document.getElementById('disp-total-monthly');
            const hiddenInput = document.getElementById('monthlyContrib'); 
            
            list.innerHTML = '';
            let total = 0;

            appState.contributionItems.forEach(item => {
                total += item.amount;
                
                const div = document.createElement('div');
                div.className = "flex justify-between items-center text-xs bg-white p-2 border border-stone-100 rounded";
                div.innerHTML = `
                    <span class="text-stone-700 truncate mr-2">${item.name}</span>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-stone-600">${formatMoney(item.amount)}</span>
                        <button onclick="removeContribItem(${item.id})" class="text-rose-400 hover:text-rose-600">Ã—</button>
                    </div>
                `;
                list.appendChild(div);
            });

            dispTotal.textContent = formatMoney(total);
            hiddenInput.value = total;
            
            calculateSimulation(); 
        }

        // --- Portfolio Logic ---
        function fillAssetInputs(selectEl) {
            const nameInput = document.getElementById('assetNameInput');
            const returnInput = document.getElementById('assetReturnInput');
            const selectedOpt = selectEl.options[selectEl.selectedIndex];
            
            if (selectedOpt.value) {
                nameInput.value = selectedOpt.value; 
                returnInput.value = selectedOpt.getAttribute('data-ret');
            }
        }

        function addAsset() {
            const nameInput = document.getElementById('assetNameInput');
            const returnInput = document.getElementById('assetReturnInput');
            const weightInput = document.getElementById('assetWeightInput');
            const selectEl = document.getElementById('assetHelperSelect');

            const name = nameInput.value.trim();
            const ret = parseFloat(returnInput.value);
            const weight = parseFloat(weightInput.value);

            if (!name) { alert("è«‹è¼¸å…¥è³‡ç”¢ä»£è™Ÿæˆ–åç¨±"); return; }
            if (isNaN(ret) || isNaN(weight) || weight <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å ±é…¬ç‡èˆ‡æ¬Šé‡æ•¸å­—"); return; }

            appState.portfolio.push({
                id: Date.now(),
                name: name,
                return: ret,
                weight: weight
            });

            nameInput.value = '';
            returnInput.value = '';
            weightInput.value = '';
            selectEl.value = ""; 
            
            updatePortfolioUI();
        }

        function removeAsset(id) {
            appState.portfolio = appState.portfolio.filter(p => p.id !== id);
            updatePortfolioUI();
        }

        function updatePortfolioUI() {
            const list = document.getElementById('portfolioList');
            const totalWeightEl = document.getElementById('totalWeight');
            const weightedReturnEl = document.getElementById('weightedReturn');
            
            list.innerHTML = '';
            
            let totalW = 0;
            let totalWeightedRet = 0;

            appState.portfolio.forEach(p => {
                totalW += p.weight;
                totalWeightedRet += (p.return * p.weight);
                
                const item = document.createElement('div');
                item.className = "flex justify-between items-center text-xs bg-white p-2 border border-stone-100 rounded";
                item.innerHTML = `
                    <div class="flex-1">
                        <span class="font-medium text-stone-700">${p.name}</span>
                        <div class="text-[10px] text-stone-400">é æœŸå ±é…¬ ${p.return}% | æ¬Šé‡ ${p.weight}%</div>
                    </div>
                    <button onclick="removeAsset(${p.id})" class="text-rose-400 hover:text-rose-600 px-2">Ã—</button>
                `;
                list.appendChild(item);
            });

            totalWeightEl.textContent = totalW + '%';
            totalWeightEl.className = totalW > 100 ? "font-bold text-rose-500" : "font-bold text-stone-700";

            let finalRet = 0;
            if (totalW > 0) {
                finalRet = totalWeightedRet / totalW;
            }
            
            weightedReturnEl.textContent = finalRet.toFixed(1) + '%';
            
            if (appState.portfolio.length > 0) {
                const slider = document.getElementById('annualReturn');
                slider.value = finalRet.toFixed(1);
                updateDisp('annualReturn', slider.value);
                updateSim();
            }
        }


        // --- Simulation (Dual Track Engine) ---
        function calculateSimulation() {
            let currentAge = parseInt(document.getElementById('currentAge').value) || 30;
            let retireAge = parseInt(document.getElementById('retireAge').value) || 65;
            let deathAge = parseInt(document.getElementById('deathAge').value) || 90;
            
            const P = parseFloat(document.getElementById('initialPrincipal').value);
            const PMT = parseFloat(document.getElementById('monthlyContrib').value) || 0;
            const g_contrib = parseFloat(document.getElementById('contribGrowth').value) / 100;
            
            // Dual Rates
            const r_principal_nom = parseFloat(document.getElementById('annualReturn').value) / 100;
            const r_dca_nom = parseFloat(document.getElementById('dcaReturn').value) / 100;
            
            const i_inf = parseFloat(document.getElementById('inflationRate').value) / 100;
            const W_target_pv = parseFloat(document.getElementById('monthlyWithdraw').value);
            const Goal_target_pv = parseFloat(document.getElementById('targetGoal').value);
            
            if (deathAge < currentAge) deathAge = currentAge; 
            
            appState.inputs = {
                currentAge, retireAge, deathAge,
                initialPrincipal: P, monthlyContrib: PMT, contribGrowth: g_contrib*100,
                annualReturn: r_principal_nom*100, dcaReturn: r_dca_nom*100, inflationRate: i_inf*100,
                monthlyWithdraw: W_target_pv, targetGoal: Goal_target_pv
            };

            // Calculated Real Rates (for display reference only)
            const r_principal_real = ((1 + r_principal_nom) / (1 + i_inf)) - 1;
            const r_dca_real = ((1 + r_dca_nom) / (1 + i_inf)) - 1; 
            // Note: We use Nominal rates for calculation loop to match inflation logic correctly

            let simulationData = [];
            
            // Dual Track Variables
            let balPrincipal = P; // Track A: Existing Assets
            let balContrib = 0;   // Track B: New DCA Assets
            let totalPrincipalPaid = P; // Only out-of-pocket cash
            
            let currentPMT = PMT;
            const totalYears = Math.max(0, deathAge - currentAge);
            
            // Monthly rates
            const r_p_m = r_principal_nom / 12;
            const r_d_m = r_dca_nom / 12;

            for(let year = 0; year <= totalYears; year++) {
                const age = currentAge + year;
                const isRetired = age >= retireAge;
                let yearlyContrib = 0;

                if (!isRetired) {
                    // Accumulation Phase
                    for(let m=0; m<12; m++) {
                        // Track A: Principal Growth
                        balPrincipal *= (1 + r_p_m);
                        
                        // Track B: DCA Growth (Annuity Due: Invest at start)
                        balContrib += currentPMT;
                        yearlyContrib += currentPMT;
                        totalPrincipalPaid += currentPMT;
                        
                        balContrib *= (1 + r_d_m);
                    }
                    currentPMT *= (1 + g_contrib);
                } else {
                    // Decumulation Phase
                    // Withdrawal Amount (Nominal)
                    let monthlyW_nominal = W_target_pv * Math.pow((1 + i_inf), year);
                    
                    for(let m=0; m<12; m++) {
                        // Pro-rata Withdrawal Logic
                        let totalBal = balPrincipal + balContrib;
                        if (totalBal > 0) {
                            let ratioP = balPrincipal / totalBal;
                            
                            // Withdraw proportionally
                            let wP = monthlyW_nominal * ratioP;
                            let wC = monthlyW_nominal * (1 - ratioP);
                            
                            balPrincipal -= wP;
                            balContrib -= wC;
                        } else {
                            // Bankruptcy
                            balPrincipal = 0;
                            balContrib = 0;
                        }
                        
                        // Growth continues
                        balPrincipal *= (1 + r_p_m);
                        balContrib *= (1 + r_d_m);
                    }
                }

                // Snapshot for Display
                let currentBalance = balPrincipal + balContrib;
                const discountFactor = 1 / Math.pow((1 + i_inf), year);
                
                let displayBalance = appState.mode === 'real' ? currentBalance * discountFactor : currentBalance;
                let displayPrincipal = appState.mode === 'real' ? totalPrincipalPaid * discountFactor : totalPrincipalPaid;
                let displayContrib = appState.mode === 'real' ? yearlyContrib * discountFactor : yearlyContrib;
                
                // Store separate components for calculating weighted return later
                // Storing Nominal components to be independent of mode for calculation
                // Note: We need Real Value of components for weight calc if mode is real, but relative ratio is same in nominal
                // Let's store Real value components for weighted avg calculation
                let compP = balPrincipal * discountFactor;
                let compD = balContrib * discountFactor;

                simulationData.push({
                    age: age,
                    yearIndex: year,
                    isRetired: isRetired,
                    balance: displayBalance,
                    principal: displayPrincipal,
                    contribution: displayContrib,
                    nominalBalance: currentBalance,
                    compPrincipal: compP,
                    compDca: compD
                });
            }

            if (simulationData.length === 0) {
                 simulationData.push({ age: currentAge, yearIndex: 0, isRetired: false, balance: P, principal: P, contribution: 0, nominalBalance: P, compPrincipal: P, compDca: 0 });
            }
            appState.results = simulationData;

            let retireData = simulationData.find(d => d.age === retireAge);
            if(!retireData) retireData = simulationData[simulationData.length-1];

            updateUI(retireData, r_principal_real, r_dca_real, Goal_target_pv); 
        }

        function updateUI(retireData, r_principal_real, r_dca_real, goalPV) {
            if (!retireData) return;
            document.getElementById('kpi-total-assets').textContent = formatMoney(retireData.balance);
            document.getElementById('kpi-principal').textContent = formatMoney(retireData.principal);
            document.getElementById('kpi-interest').textContent = formatMoney(retireData.balance - retireData.principal);

            // Solver Logic
            let inflationRate = parseFloat(document.getElementById('inflationRate').value) / 100;
            let yearsToRetire = Math.max(0, parseInt(document.getElementById('retireAge').value) - parseInt(document.getElementById('currentAge').value));
            
            let retireNominal = appState.results.find(d => d.age === parseInt(document.getElementById('retireAge').value))?.nominalBalance || retireData.nominalBalance || 0;
            let retireReal = retireNominal * (1 / Math.pow(1 + inflationRate, yearsToRetire));
            let achievementRate = (goalPV > 0) ? (retireReal / goalPV) * 100 : 100;

            document.getElementById('kpi-percent').textContent = achievementRate.toFixed(1) + "%";
            
            const badge = document.getElementById('kpi-status-badge');
            const suggest = document.getElementById('kpi-suggestion');
            const card = document.getElementById('card-status');
            
            if (achievementRate >= 100) {
                badge.textContent = "å·²é”æˆ";
                badge.className = "text-xs font-bold px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700";
                suggest.textContent = "æ­å–œï¼æ‚¨çš„è¨ˆç•«è¶³ä»¥é”æˆé€€ä¼‘ç›®æ¨™ã€‚";
                card.className = "bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-emerald-500 relative overflow-hidden";
            } else {
                badge.textContent = "æœªé”æ¨™";
                badge.className = "text-xs font-bold px-2 py-0.5 rounded-full bg-rose-100 text-rose-700";
                card.className = "bg-white p-4 rounded-xl shadow-sm border-l-4 border-l-rose-500 relative overflow-hidden";
                
                let gap = goalPV - retireReal;
                let r_dca_real_val = (appState.inputs.dcaReturn/100 - inflationRate) / (1 + inflationRate); 
                let r_m = r_dca_real_val / 12;
                let n_months = yearsToRetire * 12;
                
                if (r_m > 0 && n_months > 0) {
                    let requiredMonthly = gap * r_m / (Math.pow(1 + r_m, n_months) - 1);
                    suggest.textContent = `å»ºè­°æ¯æœˆéœ€å¤šå­˜ç´„ ${formatMoney(requiredMonthly)} (ç¾å€¼)`;
                } else {
                    suggest.textContent = "è«‹å¢åŠ æŠ•å…¥é‡‘é¡æˆ–å»¶å¾Œé€€ä¼‘";
                }
            }
            
            // Doughnut Stats
            let interest = retireData.balance - retireData.principal;
            let multiplier = retireData.principal > 0 ? (retireData.balance / retireData.principal).toFixed(2) : "0.00";
            document.getElementById('stat-multiplier').textContent = multiplier + " å€";
            
            // Calculate Weighted Average Real Return
            // Formula: (FV_principal * r_p_real + FV_dca * r_d_real) / FV_total
            let fv_p = retireData.compPrincipal;
            let fv_d = retireData.compDca;
            let total_fv = fv_p + fv_d;
            
            let weightedRealReturn = 0;
            if (total_fv > 0) {
                weightedRealReturn = (fv_p * r_principal_real + fv_d * r_dca_real) / total_fv;
            }
            
            document.getElementById('stat-real-return').textContent = formatPercent(weightedRealReturn * 100); 
            
            let ratio = retireData.principal > 0 ? (interest / retireData.principal).toFixed(1) : "0";
            document.getElementById('ratio-text').textContent = "1 : " + ratio;

            renderCharts();
            renderTable();
        }

        // --- Gemini AI ---
        async function callGeminiAdvisor() {
            const btn = document.getElementById('ai-btn');
            const responseContainer = document.getElementById('ai-response-container');
            const loading = document.getElementById('ai-loading');
            const content = document.getElementById('ai-content');

            if (!userApiKey) {
                alert("è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ API Keyï¼");
                document.getElementById('userApiKey').focus();
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span>ğŸ¤– æ·±åº¦åˆ†æä¸­...</span>';
            responseContainer.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.innerHTML = '';
            content.classList.add('hidden');

            const i = appState.inputs;
            const yearsToRetire = Math.max(0, i.retireAge - i.currentAge);
            const inflation = i.inflationRate / 100;
            
            let retireData = appState.results.find(d => d.age === i.retireAge);
            if (!retireData) retireData = appState.results[appState.results.length-1];
            
            const retireNominal = retireData?.nominalBalance || 0;
            const retireReal = retireNominal * (1 / Math.pow(1 + inflation, yearsToRetire));
            const goalReal = i.targetGoal;
            const achievementRate = (goalReal > 0) ? (retireReal / goalReal) * 100 : 100;
            const gap = goalReal - retireReal;

            // Generate Portfolio String
            let portfolioStr = "ä½¿ç”¨è€…æœªè¨­å®šå…·é«”æŠ•è³‡çµ„åˆï¼ˆä½¿ç”¨é è¨­å ±é…¬ç‡ï¼‰ã€‚";
            let customAssets = ""; 
            
            if (appState.portfolio.length > 0) {
                portfolioStr = appState.portfolio.map(p => {
                    return `- ${p.name}: é…ç½® ${p.weight}%, ä½¿ç”¨è€…è¨­å®šé æœŸå ±é…¬ ${p.return}%`;
                }).join('\n');
                customAssets = appState.portfolio.map(p => p.name).join(", ");
            }

            let contribStr = "";
            if(appState.contributionItems.length > 0) {
                contribStr = "\nã€æ¯æœˆå®šæœŸå®šé¡é …ç›® (æµé‡)ã€‘\n" + appState.contributionItems.map(item => `- ${item.name}: ${formatMoney(item.amount)}`).join('\n');
            }

            const taiwanContext = `
            ã€åƒè€ƒè³‡æ–™åº«ï¼šå°ç£é€€ä¼‘ç’°å¢ƒèˆ‡çµ±è¨ˆæ•¸æ“š (2024-2025åƒè€ƒ)ã€‘
            1. å¹³å‡é¤˜å‘½ï¼šåœ‹äººå¹³å‡ç´„ 80-81 æ­²ï¼Œä½†ä¸å¥åº·ç”Ÿå­˜å¹´æ•¸ç´„ 8 å¹´ï¼ˆéœ€é•·ç…§ï¼‰ã€‚
            2. æ¶ˆè²»æ”¯å‡ºï¼šä¾ä¸»è¨ˆç¸½è™•ï¼Œå°åŒ—å¸‚å¹³å‡æ¯äººæœˆæ¶ˆè²»ç´„ 3.4 è¬å°å¹£ï¼Œå…¨å°å¹³å‡ç´„ 2.5 è¬å°å¹£ã€‚
            3. é•·ç…§è²»ç”¨ï¼šæ©Ÿæ§‹ä½å®¿å¼æœå‹™ç´„ 3-5 è¬/æœˆï¼Œå±…å®¶çœ‹è­·ç´„ 2500-3000/æ—¥ã€‚
            4. é€€ä¼‘åˆ¶åº¦ï¼šå°ç£äººé€€ä¼‘é‡‘ä¾†æºé€šå¸¸åŒ…å«ã€Œå‹ä¿è€å¹´çµ¦ä»˜ã€ã€ã€Œå‹é€€æ–°åˆ¶ (6%)ã€èˆ‡ã€Œå€‹äººå„²è“„ã€ã€‚
            5. å¸¸è¦‹å•†å“ä»£è™Ÿï¼š0050(å…ƒå¤§å°ç£50), 0056(å…ƒå¤§é«˜è‚¡æ¯), 2330(å°ç©é›»), VOO(S&P500), BNDW(ç¸½é«”å‚µ)ã€‚
            `;

            const userPrompt = `
                è«‹æ“”ä»»ä¸€ä½å°ˆæ¥­ã€ç†Ÿæ‚‰å°ç£é‡‘èç’°å¢ƒçš„ã€Œå°ç£é€€ä¼‘ç†è²¡é¡§å•ã€ã€‚
                
                ${taiwanContext}

                ã€ä½¿ç”¨è€…æ¦‚æ³ã€‘
                - å¹´é½¡ï¼š${i.currentAge} æ­² (è·é€€ä¼‘ ${yearsToRetire} å¹´)
                - ç›®å‰å·²å‚™è³‡ç”¢ (å­˜é‡)ï¼š${formatMoney(i.initialPrincipal)} (é©ç”¨å ±é…¬ç‡ ${i.annualReturn}%)
                - æ¯æœˆç¸½æŠ•å…¥ (æµé‡)ï¼š${formatMoney(i.monthlyContrib)} (æˆé•·ç‡: ${i.contribGrowth}%, é©ç”¨å ±é…¬ç‡ ${i.dcaReturn}%)
                - é€šè†¨å‡è¨­ï¼š${i.inflationRate}%
                
                ${contribStr}

                ã€ç¾æœ‰è³‡ç”¢é…ç½® (å­˜é‡)ã€‘
                ${portfolioStr}

                ã€ç›®æ¨™åˆ†æã€‘
                - é€€ä¼‘ç›®æ¨™ (ç¾å€¼)ï¼š${formatMoney(goalReal)}
                - é ä¼°é€€ä¼‘è³‡ç”¢ (å¯¦è³ª)ï¼š${formatMoney(retireReal)}
                - é”æˆç‡ï¼š${achievementRate.toFixed(1)}%
                - ç¼ºå£ï¼š${gap > 0 ? formatMoney(gap) : "ç„¡"}
                
                ã€ä»»å‹™ã€‘
                è«‹ä½¿ç”¨ Google Search åŸ·è¡Œä»¥ä¸‹å…©å€‹å‹•ä½œï¼š
                1. é‡å°æŠ•è³‡çµ„åˆä¸­çš„è‡ªè¨‚é …ç›® (å¦‚: ${customAssets})ï¼Œæœå°‹å…¶å°æ‡‰çš„æ­£ç¢ºæ¨™çš„ï¼Œä¸¦æŸ¥æ‰¾ã€Œæ­·å²å¹´åŒ–å ±é…¬ç‡(ä¿å®ˆä¼°è¨ˆ)ã€èˆ‡ã€Œæ³¢å‹•é¢¨éšªã€ã€‚
                2. æœå°‹æœ€æ–°çš„ã€Œ2024-2025 å°ç£äººé€€ä¼‘å¹³å‡èŠ±è²»ã€ã€ã€Œé•·ç…§è²»ç”¨ã€ã€‚
                
                ä¸¦ç”¢ç”Ÿåˆ†æå ±å‘Šï¼š

                1. ğŸš¦ **é›™è»Œé…ç½®å¥æª¢ (é‡é»)**ï¼š
                   - **å­˜é‡æª¢è¦–**ï¼šç¾æœ‰è³‡ç”¢ (${i.annualReturn}%) çš„é…ç½®æ˜¯å¦éæ–¼ä¿å®ˆæˆ–æ¿€é€²ï¼Ÿ
                   - **æµé‡æª¢è¦–**ï¼šå®šæœŸå®šé¡ç­–ç•¥ (${i.dcaReturn}%) æ˜¯å¦èƒ½æœ‰æ•ˆå½Œè£œå­˜é‡çš„ä¸è¶³ï¼Ÿ
                   - çµ¦äºˆæ•´é«”æº–å‚™ç‹€æ³ç‡ˆè™Ÿï¼ˆå®‰å…¨/éœ€æ³¨æ„/å±éšªï¼‰ã€‚
                2. ğŸ” **æ”¯å‡ºé ä¼°**ï¼šå¼•ç”¨æœå°‹æ•¸æ“šï¼Œç°¡è¿°é€€ä¼‘æœˆé–‹éŠ·èˆ‡é•·ç…§æº–å‚™ã€‚
                3. ğŸ’¡ **å„ªåŒ–å»ºè­°**ï¼š
                   - é‡å°ç¼ºå£æå‡ºå…·é«”å»ºè­°ã€‚
                   - é‡å°ã€Œå­˜é‡ã€èˆ‡ã€Œæµé‡ã€åˆ†åˆ¥æå‡ºèª¿æ•´å»ºè­°ã€‚
                4. ğŸ’ª **çµèª**ï¼šæº«æš–é¼“å‹µã€‚

                è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œæ ¼å¼è«‹ä½¿ç”¨ Markdown (é‡é»å¯ç²—é«”)ã€‚**åš´ç¦ä½¿ç”¨ LaTeX æ ¼å¼ (å¦‚ $...$) æ¨™ç¤ºæ•¸å­—æˆ–é‡‘éŒ¢ï¼Œè«‹ç›´æ¥ä½¿ç”¨ç´”æ–‡å­— (å¦‚ 5 è¬/æœˆ)**ã€‚
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        tools: [{ google_search: {} }]
                    })
                });

                if (!response.ok) {
                    if(response.status === 400) throw new Error("API Key å¯èƒ½ç„¡æ•ˆæˆ–ä¸æ”¯æ´æœå°‹å·¥å…·");
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                let aiText = data.candidates[0].content.parts[0].text;
                
                const grounding = data.candidates[0].groundingMetadata;
                if (grounding && grounding.groundingChunks) {
                    aiText += "\n\n---\n**ğŸ” åƒè€ƒè³‡æ–™ä¾†æºï¼š**\n";
                    grounding.groundingChunks.forEach((chunk, idx) => {
                        if(chunk.web && chunk.web.uri) {
                            aiText += `- [${chunk.web.title || 'ä¾†æº ' + (idx+1)}](${chunk.web.uri})\n`;
                        }
                    });
                }

                loading.classList.add('hidden');
                content.classList.remove('hidden');
                content.innerHTML = marked.parse(aiText);

            } catch (error) {
                console.error(error);
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                content.innerHTML = `<p class="text-rose-600">âŒ åˆ†æå¤±æ•—<br><span class="text-xs">åŸå› : ${error.message}</span></p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>âœ¨ é‡æ–°åˆ†æ</span>';
            }
        }

        // Charts
        function renderCharts() {
            const ctxWealth = document.getElementById('wealthChart').getContext('2d');
            const ctxDoughnut = document.getElementById('doughnutChart').getContext('2d');
            
            const labels = appState.results.map(d => d.age);
            const dataBalance = appState.results.map(d => d.balance);
            const dataPrincipal = appState.results.map(d => d.principal);
            const retireAge = parseInt(document.getElementById('retireAge').value);

            if (wealthChartInstance) wealthChartInstance.destroy();
            wealthChartInstance = new Chart(ctxWealth, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'è³‡ç”¢ç¸½å€¼', data: dataBalance, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 },
                        { label: 'æŠ•å…¥æœ¬é‡‘', data: dataPrincipal, borderColor: '#d6d3d1', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + formatMoney(context.raw); } } } }, scales: { x: { grid: { display: false }, title: { display: true, text: 'å¹´é½¡' } }, y: { ticks: { callback: function(value) { return value >= 1000000 ? (value/1000000).toFixed(0) + 'M' : value/1000 + 'k'; } } } } }
            });

            if (doughnutChartInstance) doughnutChartInstance.destroy();
            let retireData = appState.results.find(d => d.age === retireAge) || appState.results[appState.results.length-1];
            let p = retireData.principal;
            let i = Math.max(0, retireData.balance - p);

            doughnutChartInstance = new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: { labels: ['æŠ•å…¥æœ¬é‡‘', 'æŠ•è³‡ç²åˆ©'], datasets: [{ data: [p, i], backgroundColor: ['#d6d3d1', '#f59e0b'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('details-table-body');
            tbody.innerHTML = '';
            appState.results.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = d.isRetired ? "bg-stone-50 text-stone-400" : "bg-white hover:bg-stone-50";
                tr.innerHTML = `
                    <td class="px-6 py-3 font-medium ${d.age === parseInt(document.getElementById('retireAge').value) ? 'text-emerald-600 font-bold' : ''}">${d.age} æ­² ${d.age === parseInt(document.getElementById('retireAge').value) ? '(é€€ä¼‘)' : ''}</td>
                    <td class="px-6 py-3">ç¬¬ ${d.yearIndex} å¹´</td>
                    <td class="px-6 py-3 text-right text-xs">${formatMoney(d.contribution)}</td>
                    <td class="px-6 py-3 text-right text-xs">${formatMoney(d.principal)}</td>
                    <td class="px-6 py-3 text-right font-bold text-stone-700">${formatMoney(d.balance)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateSim() { 
            calculateSimulation(); 
        }
        window.onload = function() { 
            // Load key from storage
            const savedKey = localStorage.getItem('gemini_api_key');
            if(savedKey) {
                document.getElementById('userApiKey').value = savedKey;
                userApiKey = savedKey;
            }
            updateContribUI(); 
        };
    </script>
</body>
</html>
